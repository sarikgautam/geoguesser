<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoGuessr Clone</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .mapboxgl-popup-content {
            padding: 10px;
            border-radius: 8px;
        }

        .street-view-container {
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Street View component using Mapbox Static Images API
        function StreetView({ location }) {
            const [imageUrl, setImageUrl] = useState('');
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(false);

            useEffect(() => {
                if (location) {
                    setLoading(true);
                    setError(false);

                    // Generate a random bearing for variety
                    const bearing = Math.floor(Math.random() * 360);
                    const pitch = Math.floor(Math.random() * 20) - 10; // -10 to 10 degrees

                    // Use Mapbox Static Images API to get street-level imagery
                    const url = `https://api.mapbox.com/styles/v1/mapbox/streets-v11/static/${location.lng},${location.lat},16,${bearing},${pitch}/800x600@2x?access_token=${MAPBOX_TOKEN}`;

                    setImageUrl(url);

                    // Simulate loading time
                    setTimeout(() => {
                        setLoading(false);
                    }, 500);
                }
            }, [location]);

            if (!location) {
                return (
                    <div className="street-view-container h-full">
                        <div className="text-center">
                            <div className="text-6xl mb-4">üåç</div>
                            <h2 className="text-2xl font-bold mb-2">Starting Game...</h2>
                        </div>
                    </div>
                );
            }

            if (loading) {
                return (
                    <div className="street-view-container h-full">
                        <div className="text-center">
                            <div className="text-6xl mb-4 animate-pulse">üìç</div>
                            <h2 className="text-2xl font-bold mb-2">Loading Location...</h2>
                            <div className="w-16 h-1 bg-white bg-opacity-30 rounded-full mx-auto">
                                <div className="h-full bg-white rounded-full animate-pulse"></div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="street-view-container h-full">
                        <div className="text-center">
                            <div className="text-6xl mb-4">üó∫Ô∏è</div>
                            <h2 className="text-2xl font-bold mb-2">Mystery Location</h2>
                            <p className="text-lg opacity-80">Where in the world are you?</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="h-full w-full relative overflow-hidden">
                    <img
                        src={imageUrl}
                        alt="Street view"
                        className="w-full h-full object-cover"
                        onError={() => {
                            setError(true);
                        }}
                        onLoad={() => {
                            setLoading(false);
                        }}
                    />
                    <div className="absolute bottom-4 left-4 bg-black bg-opacity-50 text-white px-3 py-2 rounded-lg text-sm">
                        üìç Mystery Location
                    </div>
                </div>
            );
        }

        // Expanded locations for different regions with many more cities
        const LOCATIONS = {
            world: [
                // Europe
                { lat: 48.8584, lng: 2.2945, name: "Eiffel Tower, Paris" },
                { lat: 51.5007, lng: -0.1246, name: "Big Ben, London" },
                { lat: 52.5163, lng: 13.3777, name: "Brandenburg Gate, Berlin" },
                { lat: 41.8902, lng: 12.4922, name: "Colosseum, Rome" },
                { lat: 40.4168, lng: -3.7038, name: "Puerta del Sol, Madrid" },
                { lat: 59.3293, lng: 18.0686, name: "Gamla Stan, Stockholm" },
                { lat: 50.0755, lng: 14.4378, name: "Old Town Square, Prague" },
                { lat: 47.4979, lng: 19.0402, name: "Parliament, Budapest" },
                { lat: 38.7071, lng: -9.1359, name: "Rossio Square, Lisbon" },
                { lat: 55.6761, lng: 12.5683, name: "Nyhavn, Copenhagen" },
                { lat: 52.3676, lng: 4.9041, name: "Dam Square, Amsterdam" },
                { lat: 46.9480, lng: 7.4474, name: "Old Town, Bern" },
                { lat: 47.0379, lng: 15.4237, name: "Hauptplatz, Graz" },
                { lat: 60.1699, lng: 24.9384, name: "Senate Square, Helsinki" },
                { lat: 59.9139, lng: 10.7522, name: "Karl Johans Gate, Oslo" },
                { lat: 49.4521, lng: 11.0767, name: "Nuremberg, Germany" },
                { lat: 50.9375, lng: 6.9603, name: "Cologne, Germany" },
                { lat: 53.5511, lng: 9.9937, name: "Hamburg, Germany" },
                { lat: 48.7758, lng: 9.1829, name: "Stuttgart, Germany" },
                { lat: 51.0504, lng: 13.7373, name: "Dresden, Germany" },

                // Asia
                { lat: 35.6586, lng: 139.7454, name: "Shibuya Crossing, Tokyo" },
                { lat: 39.9042, lng: 116.4074, name: "Forbidden City, Beijing" },
                { lat: 1.2966, lng: 103.8764, name: "Marina Bay, Singapore" },
                { lat: 22.3193, lng: 114.1694, name: "Victoria Harbour, Hong Kong" },
                { lat: 37.5665, lng: 126.9780, name: "Gangnam District, Seoul" },
                { lat: 28.6139, lng: 77.2090, name: "India Gate, New Delhi" },
                { lat: 19.0760, lng: 72.8777, name: "Gateway of India, Mumbai" },
                { lat: 13.7563, lng: 100.5018, name: "Grand Palace, Bangkok" },
                { lat: 21.0285, lng: 105.8542, name: "Hoan Kiem Lake, Hanoi" },
                { lat: 10.8231, lng: 106.6297, name: "Notre Dame Cathedral, Ho Chi Minh City" },
                { lat: 3.1390, lng: 101.6869, name: "Petronas Towers, Kuala Lumpur" },
                { lat: -6.2088, lng: 106.8456, name: "National Monument, Jakarta" },
                { lat: 14.5995, lng: 120.9842, name: "Rizal Park, Manila" },
                { lat: 25.2048, lng: 55.2708, name: "Burj Khalifa, Dubai" },
                { lat: 31.2304, lng: 121.4737, name: "The Bund, Shanghai" },
                { lat: 27.7172, lng: 85.3240, name: "Kathmandu, Nepal" },
                { lat: 28.2096, lng: 83.9856, name: "Pokhara, Nepal" },
                { lat: 27.6844, lng: 85.3446, name: "Bhaktapur, Nepal" },
                { lat: 26.4838, lng: 87.2832, name: "Biratnagar, Nepal" },
                { lat: 27.5330, lng: 84.5000, name: "Chitwan, Nepal" },

                // Americas
                { lat: 40.7589, lng: -73.9851, name: "Times Square, New York" },
                { lat: 34.1341, lng: -118.3215, name: "Hollywood Blvd, Los Angeles" },
                { lat: -22.9519, lng: -43.2105, name: "Christ the Redeemer, Rio" },
                { lat: 19.4326, lng: -99.1332, name: "Z√≥calo, Mexico City" },
                { lat: -34.6037, lng: -58.3816, name: "Plaza de Mayo, Buenos Aires" },
                { lat: -33.4489, lng: -70.6693, name: "Plaza de Armas, Santiago" },
                { lat: 4.7110, lng: -74.0721, name: "Plaza Bol√≠var, Bogot√°" },
                { lat: -12.0464, lng: -77.0428, name: "Plaza de Armas, Lima" },
                { lat: 45.5017, lng: -73.5673, name: "Old Montreal, Montreal" },
                { lat: 49.2827, lng: -123.1207, name: "Stanley Park, Vancouver" },
                { lat: 43.6532, lng: -79.3832, name: "CN Tower, Toronto" },
                { lat: 46.8139, lng: -71.2082, name: "Quebec City, Canada" },
                { lat: 43.651070, lng: -79.347015, name: "Toronto, Canada" },
                { lat: 45.5017, lng: -73.5673, name: "Montreal, Canada" },
                { lat: 53.5461, lng: -113.4938, name: "Edmonton, Canada" },
                { lat: 49.2827, lng: -123.1207, name: "Vancouver, Canada" },
                { lat: 36.1699, lng: -115.1398, name: "Las Vegas, USA" },
                { lat: 30.2672, lng: -97.7431, name: "Austin, Texas, USA" },
                { lat: 44.9778, lng: -93.2650, name: "Minneapolis, USA" },
                { lat: 35.0844, lng: -106.6504, name: "Albuquerque, USA" },
                { lat: 33.4484, lng: -112.0740, name: "Phoenix, Arizona, USA" },


                // Africa & Middle East
                { lat: -26.2041, lng: 28.0473, name: "Johannesburg CBD" },
                { lat: -33.9249, lng: 18.4241, name: "Table Mountain, Cape Town" },
                { lat: 30.0444, lng: 31.2357, name: "Tahrir Square, Cairo" },
                { lat: 33.8869, lng: 9.5375, name: "Medina, Tunis" },
                { lat: 33.5731, lng: -7.5898, name: "Hassan II Mosque, Casablanca" },
                { lat: 36.8065, lng: 10.1815, name: "Medina, Tunis" },
                { lat: 31.7683, lng: 35.2137, name: "Old City, Jerusalem" },
                { lat: 33.8938, lng: 35.5018, name: "Martyrs' Square, Beirut" },
                { lat: 41.0082, lng: 28.9784, name: "Sultanahmet, Istanbul" },

                // Oceania
                { lat: -33.8568, lng: 151.2153, name: "Sydney Opera House" },
                { lat: -37.8136, lng: 144.9631, name: "Federation Square, Melbourne" },
                { lat: -27.4698, lng: 153.0251, name: "South Bank, Brisbane" },
                { lat: -31.9505, lng: 115.8605, name: "Kings Park, Perth" },
                { lat: -41.2865, lng: 174.7762, name: "Te Papa, Wellington" },
                { lat: -36.8485, lng: 174.7633, name: "Sky Tower, Auckland" },
                { lat: -28.0167, lng: 153.4000, name: "Gold Coast, Australia" },
                { lat: -23.6980, lng: 133.8807, name: "Alice Springs, Australia" },
                { lat: -31.9535, lng: 115.8575, name: "Perth, Australia" },
                { lat: -35.2809, lng: 149.1300, name: "Canberra, Australia" },
                { lat: -37.8140, lng: 144.9633, name: "Melbourne, Australia" }
            ],
            usa: [
                // Major Cities
                { lat: 40.7589, lng: -73.9851, name: "Times Square, NYC" },
                { lat: 34.1341, lng: -118.3215, name: "Hollywood Blvd, LA" },
                { lat: 41.8781, lng: -87.6298, name: "Millennium Park, Chicago" },
                { lat: 29.7604, lng: -95.3698, name: "Downtown Houston" },
                { lat: 33.4484, lng: -112.0740, name: "Downtown Phoenix" },
                { lat: 39.9496, lng: -75.1503, name: "Independence Hall, Philadelphia" },
                { lat: 29.4241, lng: -98.4936, name: "River Walk, San Antonio" },
                { lat: 32.7767, lng: -96.7970, name: "Dealey Plaza, Dallas" },
                { lat: 37.8199, lng: -122.4783, name: "Golden Gate Bridge, SF" },
                { lat: 47.6205, lng: -122.3493, name: "Pike Place Market, Seattle" },

                // More Cities
                { lat: 25.7617, lng: -80.1918, name: "South Beach, Miami" },
                { lat: 36.1627, lng: -86.7816, name: "Music Row, Nashville" },
                { lat: 30.2672, lng: -97.7431, name: "State Capitol, Austin" },
                { lat: 39.7392, lng: -104.9903, name: "Union Station, Denver" },
                { lat: 45.5152, lng: -122.6784, name: "Pioneer Courthouse Square, Portland" },
                { lat: 44.9778, lng: -93.2650, name: "Mill City Museum, Minneapolis" },
                { lat: 42.3601, lng: -71.0589, name: "Boston Common, Boston" },
                { lat: 38.9072, lng: -77.0369, name: "National Mall, Washington DC" },
                { lat: 33.7490, lng: -84.3880, name: "Centennial Olympic Park, Atlanta" },
                { lat: 39.2904, lng: -76.6122, name: "Inner Harbor, Baltimore" },
                { lat: 41.4993, lng: -81.6944, name: "Public Square, Cleveland" },
                { lat: 42.3314, lng: -83.0458, name: "Hart Plaza, Detroit" },
                { lat: 38.6270, lng: -90.1994, name: "Gateway Arch, St. Louis" },
                { lat: 35.2271, lng: -80.8431, name: "Uptown, Charlotte" },
                { lat: 35.7796, lng: -78.6382, name: "State Capitol, Raleigh" },
                { lat: 26.1224, lng: -80.1373, name: "Las Olas Boulevard, Fort Lauderdale" },
                { lat: 27.9506, lng: -82.4572, name: "Bayshore Boulevard, Tampa" },
                { lat: 32.0835, lng: -81.0998, name: "Historic District, Savannah" },
                { lat: 29.9511, lng: -90.0715, name: "French Quarter, New Orleans" },
                { lat: 36.1540, lng: -95.9928, name: "Brady Arts District, Tulsa" },
                { lat: 35.4676, lng: -97.5164, name: "Bricktown, Oklahoma City" }
            ],
            europe: [
                // Western Europe
                { lat: 48.8584, lng: 2.2945, name: "Eiffel Tower, Paris" },
                { lat: 51.5007, lng: -0.1246, name: "Big Ben, London" },
                { lat: 52.5163, lng: 13.3777, name: "Brandenburg Gate, Berlin" },
                { lat: 41.8902, lng: 12.4922, name: "Colosseum, Rome" },
                { lat: 40.4168, lng: -3.7038, name: "Puerta del Sol, Madrid" },
                { lat: 52.3676, lng: 4.9041, name: "Dam Square, Amsterdam" },
                { lat: 50.8503, lng: 4.3517, name: "Grand Place, Brussels" },
                { lat: 46.9480, lng: 7.4474, name: "Old Town, Bern" },
                { lat: 47.0379, lng: 15.4237, name: "Hauptplatz, Graz" },
                { lat: 48.2082, lng: 16.3738, name: "Stephansplatz, Vienna" },
                { lat: 50.0755, lng: 14.4378, name: "Old Town Square, Prague" },
                { lat: 47.4979, lng: 19.0402, name: "Parliament, Budapest" },
                { lat: 38.7071, lng: -9.1359, name: "Rossio Square, Lisbon" },
                { lat: 41.3851, lng: 2.1734, name: "Sagrada Familia, Barcelona" },
                { lat: 45.4642, lng: 9.1900, name: "Duomo, Milan" },
                { lat: 43.7696, lng: 11.2558, name: "Piazza del Duomo, Florence" },
                { lat: 40.8518, lng: 14.2681, name: "Piazza del Plebiscito, Naples" },
                { lat: 51.0486, lng: 13.7373, name: "Frauenkirche, Dresden" },
                { lat: 53.5511, lng: 9.9937, name: "Speicherstadt, Hamburg" },
                { lat: 48.1351, lng: 11.5820, name: "Marienplatz, Munich" },

                // Northern Europe
                { lat: 59.3293, lng: 18.0686, name: "Gamla Stan, Stockholm" },
                { lat: 55.6761, lng: 12.5683, name: "Nyhavn, Copenhagen" },
                { lat: 60.1699, lng: 24.9384, name: "Senate Square, Helsinki" },
                { lat: 59.9139, lng: 10.7522, name: "Karl Johans Gate, Oslo" },
                { lat: 64.1466, lng: -21.9426, name: "Hallgr√≠mskirkja, Reykjavik" },
                { lat: 53.3498, lng: -6.2603, name: "Temple Bar, Dublin" },
                { lat: 55.9533, lng: -3.1883, name: "Royal Mile, Edinburgh" },
                { lat: 51.4816, lng: -3.1791, name: "Cardiff Castle, Cardiff" },

                // Eastern Europe
                { lat: 55.7539, lng: 37.6208, name: "Red Square, Moscow" },
                { lat: 59.9311, lng: 30.3609, name: "Palace Square, St. Petersburg" },
                { lat: 52.2297, lng: 21.0122, name: "Old Town, Warsaw" },
                { lat: 50.0647, lng: 19.9450, name: "Main Market Square, Krakow" },
                { lat: 44.4268, lng: 26.1025, name: "Old Town, Bucharest" },
                { lat: 42.6977, lng: 23.3219, name: "Alexander Nevsky Cathedral, Sofia" },
                { lat: 45.8150, lng: 15.9819, name: "Ban Jelaƒçiƒá Square, Zagreb" },
                { lat: 46.0569, lng: 14.5058, name: "Pre≈°eren Square, Ljubljana" },
                { lat: 48.1486, lng: 17.1077, name: "Old Town, Bratislava" },
                { lat: 50.4501, lng: 30.5234, name: "Independence Square, Kiev" }
            ]
        };

        // Using a mapbox token
        const MAPBOX_TOKEN = 'pk.eyJ1Ijoic2FyaWtnYXV0YW0iLCJhIjoiY2s0NW5nY3VrMGJhbjNtcGk1ZjVjc290byJ9.SsMxIG3adgCn5Zak24IKFg';

        function GeoGuessrGame() {
            const [gameState, setGameState] = useState('menu'); // menu, playing, results
            const [currentRound, setCurrentRound] = useState(1);
            const [totalRounds, setTotalRounds] = useState(5);
            const [score, setScore] = useState(0);
            const [roundScores, setRoundScores] = useState([]);
            const [currentLocation, setCurrentLocation] = useState(null);
            const [guessedLocation, setGuessedLocation] = useState(null);
            const [mapMode, setMapMode] = useState('world');
            const [showResult, setShowResult] = useState(false);
            const [distance, setDistance] = useState(0);
            const [timeLeft, setTimeLeft] = useState(60);
            const [timerDuration, setTimerDuration] = useState(60);
            const [timerActive, setTimerActive] = useState(false);
            const mapContainer = useRef(null);
            const map = useRef(null);
            const timerRef = useRef(null);

            // Calculate distance between two points using Haversine formula
            const calculateDistance = (lat1, lng1, lat2, lng2) => {
                const R = 6371; // Earth's radius in kilometers
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLng = (lng2 - lng1) * Math.PI / 180;
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng / 2) * Math.sin(dLng / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            };

            // Calculate score based on distance (max 5000 points)
            const calculateScore = (distance) => {
                if (distance === 0) return 5000;
                return Math.max(0, Math.round(5000 * Math.exp(-distance / 2000)));
            };

            // Timer effect
            useEffect(() => {
                if (timerActive && timeLeft > 0 && !showResult) {
                    timerRef.current = setTimeout(() => {
                        setTimeLeft(prev => {
                            const newTime = prev - 1;
                            if (newTime === 0) {
                                // Time's up - auto submit with no guess or current guess
                                setTimeout(() => handleTimeUp(), 100);
                            }
                            return newTime;
                        });
                    }, 1000);
                }

                return () => {
                    if (timerRef.current) {
                        clearTimeout(timerRef.current);
                    }
                };
            }, [timerActive, timeLeft, showResult]);

            // Handle time up
            const handleTimeUp = () => {
                if (showResult || !timerActive) return; // Prevent double execution

                setTimerActive(false);

                if (!guessedLocation || !currentLocation) {
                    // No guess made - assign maximum distance penalty
                    const dist = 20000; // Maximum distance for scoring
                    const roundScore = 0; // No points for no guess
                    setDistance(dist);
                    setScore(prev => prev + roundScore);
                    setRoundScores(prev => [...prev, roundScore]);
                    setShowResult(true);
                } else {
                    // Submit current guess
                    const dist = calculateDistance(
                        currentLocation.lat, currentLocation.lng,
                        guessedLocation.lat, guessedLocation.lng
                    );

                    const roundScore = calculateScore(dist);
                    setDistance(dist);
                    setScore(prev => prev + roundScore);
                    setRoundScores(prev => [...prev, roundScore]);
                    setShowResult(true);

                    // Add correct location marker
                    if (map.current) {
                        new mapboxgl.Marker({ color: 'green' })
                            .setLngLat([currentLocation.lng, currentLocation.lat])
                            .setPopup(new mapboxgl.Popup().setHTML(`<strong>${currentLocation.name}</strong>`))
                            .addTo(map.current);

                        // Draw line between guess and correct location
                        if (map.current.getSource('route')) {
                            map.current.removeLayer('route');
                            map.current.removeSource('route');
                        }

                        map.current.addSource('route', {
                            'type': 'geojson',
                            'data': {
                                'type': 'Feature',
                                'properties': {},
                                'geometry': {
                                    'type': 'LineString',
                                    'coordinates': [
                                        [guessedLocation.lng, guessedLocation.lat],
                                        [currentLocation.lng, currentLocation.lat]
                                    ]
                                }
                            }
                        });

                        map.current.addLayer({
                            'id': 'route',
                            'type': 'line',
                            'source': 'route',
                            'layout': {
                                'line-join': 'round',
                                'line-cap': 'round'
                            },
                            'paint': {
                                'line-color': '#ff6b6b',
                                'line-width': 3,
                                'line-dasharray': [2, 2]
                            }
                        });
                    }
                }
            };

            // Initialize map
            useEffect(() => {
                if (gameState === 'playing' && mapContainer.current && !map.current) {
                    try {
                        mapboxgl.accessToken = MAPBOX_TOKEN;

                        map.current = new mapboxgl.Map({
                            container: mapContainer.current,
                            style: 'mapbox://styles/mapbox/streets-v11',
                            center: [0, 20],
                            zoom: 1.5
                        });

                        map.current.on('load', () => {
                            console.log('Map loaded successfully');
                        });

                        map.current.on('error', (e) => {
                            console.error('Map error:', e);
                        });

                        map.current.on('click', (e) => {
                            if (!showResult && timerActive) {
                                const { lng, lat } = e.lngLat;
                                setGuessedLocation({ lat, lng });

                                // Clear existing markers
                                const existingMarkers = document.querySelectorAll('.mapboxgl-marker[style*="red"]');
                                existingMarkers.forEach(marker => marker.remove());

                                // Add guess marker
                                new mapboxgl.Marker({ color: 'red' })
                                    .setLngLat([lng, lat])
                                    .addTo(map.current);
                            }
                        });
                    } catch (error) {
                        console.error('Error initializing map:', error);
                    }
                }
            }, [gameState, showResult, timerActive]);

            // Start new game
            const startGame = (mode, rounds = 5, timer = 60) => {
                console.log('Starting game with:', { mode, rounds, timer });
                setMapMode(mode);
                setTotalRounds(rounds);
                setTimerDuration(timer);
                setGameState('playing');
                setCurrentRound(1);
                setScore(0);
                setRoundScores([]);
                startNewRound(mode);
            };

            // Start new round
            const startNewRound = (mode = mapMode) => {
                console.log('Starting new round with mode:', mode);
                const locations = LOCATIONS[mode] || LOCATIONS.world;
                const randomLocation = locations[Math.floor(Math.random() * locations.length)];
                console.log('Selected location:', randomLocation);
                setCurrentLocation(randomLocation);
                setGuessedLocation(null);
                setShowResult(false);
                setDistance(0);
                setTimeLeft(timerDuration);
                setTimerActive(true);

                // Clear map markers and routes
                if (map.current) {
                    const markers = document.querySelectorAll('.mapboxgl-marker');
                    markers.forEach(marker => marker.remove());

                    if (map.current.getLayer && map.current.getLayer('route')) {
                        map.current.removeLayer('route');
                        map.current.removeSource('route');
                    }
                }
            };

            // Submit guess
            const submitGuess = () => {
                if (!currentLocation || showResult) return;

                setTimerActive(false);

                if (!guessedLocation) {
                    // No guess made
                    const dist = 20000;
                    const roundScore = 0;
                    setDistance(dist);
                    setScore(prev => prev + roundScore);
                    setRoundScores(prev => [...prev, roundScore]);
                    setShowResult(true);
                    return;
                }

                const dist = calculateDistance(
                    currentLocation.lat, currentLocation.lng,
                    guessedLocation.lat, guessedLocation.lng
                );

                const roundScore = calculateScore(dist);
                setDistance(dist);
                setScore(prev => prev + roundScore);
                setRoundScores(prev => [...prev, roundScore]);
                setShowResult(true);

                // Add correct location marker
                if (map.current) {
                    new mapboxgl.Marker({ color: 'green' })
                        .setLngLat([currentLocation.lng, currentLocation.lat])
                        .setPopup(new mapboxgl.Popup().setHTML(`<strong>${currentLocation.name}</strong>`))
                        .addTo(map.current);

                    // Draw line between guess and correct location
                    if (map.current.getSource('route')) {
                        map.current.removeLayer('route');
                        map.current.removeSource('route');
                    }

                    map.current.addSource('route', {
                        'type': 'geojson',
                        'data': {
                            'type': 'Feature',
                            'properties': {},
                            'geometry': {
                                'type': 'LineString',
                                'coordinates': [
                                    [guessedLocation.lng, guessedLocation.lat],
                                    [currentLocation.lng, currentLocation.lat]
                                ]
                            }
                        }
                    });

                    map.current.addLayer({
                        'id': 'route',
                        'type': 'line',
                        'source': 'route',
                        'layout': {
                            'line-join': 'round',
                            'line-cap': 'round'
                        },
                        'paint': {
                            'line-color': '#ff6b6b',
                            'line-width': 3,
                            'line-dasharray': [2, 2]
                        }
                    });
                }
            };

            // Next round
            const nextRound = () => {
                if (currentRound < totalRounds) {
                    setCurrentRound(prev => prev + 1);
                    startNewRound();
                } else {
                    setTimerActive(false);
                    setGameState('results');
                }
            };

            // Reset game
            const resetGame = () => {
                setGameState('menu');
                setTimerActive(false);
                if (timerRef.current) {
                    clearTimeout(timerRef.current);
                }
                if (map.current) {
                    map.current.remove();
                    map.current = null;
                }
            };

            // Menu Screen
            if (gameState === 'menu') {
                const [selectedMode, setSelectedMode] = useState('world');
                const [selectedRounds, setSelectedRounds] = useState(5);
                const [selectedTimer, setSelectedTimer] = useState(60);

                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-600 to-purple-700 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full text-center">
                            <h1 className="text-4xl font-bold text-gray-800 mb-2">GeoGuessr</h1>
                            <p className="text-gray-600 mb-8">Test your geography knowledge!</p>

                            {/* Game Mode Selection */}
                            <div className="mb-6">
                                <h3 className="text-lg font-semibold text-gray-700 mb-3">Choose Game Mode</h3>
                                <div className="space-y-3">
                                    <button
                                        onClick={() => setSelectedMode('world')}
                                        className={`w-full font-semibold py-3 px-6 rounded-lg transition duration-200 ${selectedMode === 'world'
                                                ? 'bg-blue-600 text-white'
                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                            }`}
                                    >
                                        üåç World Mode
                                    </button>
                                    <button
                                        onClick={() => setSelectedMode('usa')}
                                        className={`w-full font-semibold py-3 px-6 rounded-lg transition duration-200 ${selectedMode === 'usa'
                                                ? 'bg-red-600 text-white'
                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                            }`}
                                    >
                                        üá∫üá∏ USA Mode
                                    </button>
                                    <button
                                        onClick={() => setSelectedMode('europe')}
                                        className={`w-full font-semibold py-3 px-6 rounded-lg transition duration-200 ${selectedMode === 'europe'
                                                ? 'bg-green-600 text-white'
                                                : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                            }`}
                                    >
                                        üá™üá∫ Europe Mode
                                    </button>
                                </div>
                            </div>

                            {/* Round Selection */}
                            <div className="mb-6">
                                <h3 className="text-lg font-semibold text-gray-700 mb-3">Number of Rounds</h3>
                                <div className="grid grid-cols-4 gap-2">
                                    {[5, 10, 15, 20].map(rounds => (
                                        <button
                                            key={rounds}
                                            onClick={() => setSelectedRounds(rounds)}
                                            className={`py-2 px-3 rounded-lg font-semibold transition duration-200 ${selectedRounds === rounds
                                                    ? 'bg-purple-600 text-white'
                                                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                }`}
                                        >
                                            {rounds}
                                        </button>
                                    ))}
                                </div>
                                <div className="mt-3">
                                    <input
                                        type="number"
                                        min="1"
                                        max="50"
                                        value={selectedRounds}
                                        onChange={(e) => setSelectedRounds(Math.max(1, Math.min(50, parseInt(e.target.value) || 5)))}
                                        className="w-24 px-3 py-2 border border-gray-300 rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-purple-500"
                                        placeholder="Custom"
                                    />
                                    <p className="text-xs text-gray-500 mt-1">Or enter custom (1-50)</p>
                                </div>
                            </div>

                            {/* Timer Selection */}
                            <div className="mb-8">
                                <h3 className="text-lg font-semibold text-gray-700 mb-3">Timer per Round</h3>
                                <div className="grid grid-cols-4 gap-2">
                                    {[30, 60, 120, 300].map(seconds => (
                                        <button
                                            key={seconds}
                                            onClick={() => setSelectedTimer(seconds)}
                                            className={`py-2 px-3 rounded-lg font-semibold transition duration-200 text-sm ${selectedTimer === seconds
                                                    ? 'bg-orange-600 text-white'
                                                    : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                                }`}
                                        >
                                            {seconds < 60 ? `${seconds}s` : `${seconds / 60}m`}
                                        </button>
                                    ))}
                                </div>
                                <div className="mt-3">
                                    <input
                                        type="number"
                                        min="10"
                                        max="600"
                                        value={selectedTimer}
                                        onChange={(e) => setSelectedTimer(Math.max(10, Math.min(600, parseInt(e.target.value) || 60)))}
                                        className="w-24 px-3 py-2 border border-gray-300 rounded-lg text-center focus:outline-none focus:ring-2 focus:ring-orange-500"
                                        placeholder="Custom"
                                    />
                                    <p className="text-xs text-gray-500 mt-1">Custom seconds (10-600)</p>
                                </div>
                            </div>

                            {/* Start Game Button */}
                            <button
                                onClick={() => startGame(selectedMode, selectedRounds, selectedTimer)}
                                className="w-full bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white font-bold py-4 px-6 rounded-lg transition duration-200 text-lg"
                            >
                                Start Game ({selectedRounds} rounds, {selectedTimer < 60 ? `${selectedTimer}s` : `${selectedTimer / 60}m`})
                            </button>

                            <div className="mt-6 text-sm text-gray-500">
                                <p>‚Ä¢ Click on the map to guess</p>
                                <p>‚Ä¢ Closer guesses = higher scores</p>
                                <p>‚Ä¢ Max 5,000 points per round</p>
                            </div>
                        </div>
                    </div>
                );
            }

            // Results Screen
            if (gameState === 'results') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-green-600 to-blue-700 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center">
                            <h1 className="text-3xl font-bold text-gray-800 mb-4">Game Complete!</h1>

                            <div className="bg-gradient-to-r from-yellow-400 to-orange-500 text-white rounded-lg p-6 mb-6">
                                <h2 className="text-2xl font-bold">Final Score</h2>
                                <p className="text-4xl font-bold">{score.toLocaleString()}</p>
                                <p className="text-sm opacity-90">out of {(totalRounds * 5000).toLocaleString()} points</p>
                            </div>

                            <div className="space-y-2 mb-6">
                                <h3 className="font-semibold text-gray-700">Round Breakdown:</h3>
                                {roundScores.map((roundScore, index) => (
                                    <div key={index} className="flex justify-between items-center bg-gray-100 rounded px-3 py-2">
                                        <span>Round {index + 1}</span>
                                        <span className="font-semibold">{roundScore.toLocaleString()}</span>
                                    </div>
                                ))}
                            </div>

                            <button
                                onClick={resetGame}
                                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200"
                            >
                                Play Again
                            </button>
                        </div>
                    </div>
                );
            }

            // Game Screen
            return (
                <div className="h-screen flex flex-col bg-gray-100">
                    {/* Header */}
                    <div className="bg-white shadow-md p-4 flex justify-between items-center">
                        <div className="flex items-center space-x-4">
                            <h1 className="text-2xl font-bold text-gray-800">GeoGuessr</h1>
                            <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">
                                {mapMode.toUpperCase()}
                            </span>
                        </div>

                        <div className="flex items-center space-x-6">
                            <div className="text-center">
                                <p className="text-sm text-gray-600">Timer</p>
                                <p className={`text-xl font-bold ${timeLeft <= 10 ? 'text-red-600' : timeLeft <= 30 ? 'text-orange-600' : 'text-blue-600'}`}>
                                    {Math.floor(timeLeft / 60)}:{(timeLeft % 60).toString().padStart(2, '0')}
                                </p>
                            </div>
                            <div className="text-center">
                                <p className="text-sm text-gray-600">Round</p>
                                <p className="text-xl font-bold">{currentRound}/{totalRounds}</p>
                            </div>
                            <div className="text-center">
                                <p className="text-sm text-gray-600">Score</p>
                                <p className="text-xl font-bold text-green-600">{score.toLocaleString()}</p>
                            </div>
                        </div>
                    </div>

                    {/* Main Game Area */}
                    <div className="flex-1 flex">
                        {/* Street View */}
                        <div className="w-1/2 relative">
                            <StreetView location={currentLocation} />
                        </div>

                        {/* Map */}
                        <div className="w-1/2 relative">
                            <div ref={mapContainer} className="h-full" />

                            {/* Map Instructions */}
                            {!guessedLocation && !showResult && (
                                <div className="absolute top-4 left-4 bg-white bg-opacity-90 rounded-lg p-3 shadow-lg">
                                    <p className="text-sm font-semibold text-gray-700">
                                        Click on the map to make your guess!
                                    </p>
                                </div>
                            )}

                            {/* Guess Button */}
                            {guessedLocation && !showResult && timerActive && (
                                <div className="absolute bottom-4 left-4 right-4">
                                    <button
                                        onClick={submitGuess}
                                        className="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 shadow-lg"
                                    >
                                        Submit Guess
                                    </button>
                                </div>
                            )}

                            {/* Result Panel */}
                            {showResult && (
                                <div className="absolute bottom-4 left-4 right-4 bg-white rounded-lg shadow-lg p-4">
                                    <div className="text-center mb-4">
                                        <h3 className="text-lg font-bold text-gray-800">Round {currentRound} Result</h3>
                                        <p className="text-2xl font-bold text-green-600">
                                            +{calculateScore(distance).toLocaleString()} points
                                        </p>
                                        <p className="text-sm text-gray-600">
                                            {distance >= 20000 ? 'No guess made' : `Distance: ${Math.round(distance).toLocaleString()} km`}
                                        </p>
                                        {timeLeft === 0 && <p className="text-sm text-red-600">‚è∞ Time's up!</p>}
                                        <p className="text-sm text-gray-700 mt-2">
                                            <strong>Correct location:</strong> {currentLocation?.name}
                                        </p>
                                    </div>

                                    <button
                                        onClick={nextRound}
                                        className="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200"
                                    >
                                        {currentRound < totalRounds ? 'Next Round' : 'View Results'}
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<GeoGuessrGame />, document.getElementById('root'));
    </script>
    <script>(function () { function c() { var b = a.contentDocument || a.contentWindow.document; if (b) { var d = b.createElement('script'); d.innerHTML = "window.__CF$cv$params={r:'9647b0d093ff5733',t:'MTc1MzQwNDkxNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);"; b.getElementsByTagName('head')[0].appendChild(d) } } if (document.body) { var a = document.createElement('iframe'); a.height = 1; a.width = 1; a.style.position = 'absolute'; a.style.top = 0; a.style.left = 0; a.style.border = 'none'; a.style.visibility = 'hidden'; document.body.appendChild(a); if ('loading' !== document.readyState) c(); else if (window.addEventListener) document.addEventListener('DOMContentLoaded', c); else { var e = document.onreadystatechange || function () { }; document.onreadystatechange = function (b) { e(b); 'loading' !== document.readyState && (document.onreadystatechange = e, c()) } } } })();</script>
</body>

</html>